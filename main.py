import telebot
import subprocess
import os

# ‚ö†Ô∏è –í–ê–ñ–ù–û: –ó–∞–º–µ–Ω–∏—Ç–µ '–í–ê–®_–¢–û–ö–ï–ù' –Ω–∞ —Ç–æ–∫–µ–Ω –≤–∞—à–µ–≥–æ –±–æ—Ç–∞, –ø–æ–ª—É—á–µ–Ω–Ω—ã–π –æ—Ç BotFather.
TOKEN = '8553698468:AAF3J4PMcSditZ3FEB-KRKSpzyGC0xbxopo' 

bot = telebot.TeleBot(TOKEN)

## ü§ñ –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /start
@bot.message_handler(commands=['start'])
def send_welcome(message):
    """–û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ."""
    welcome_text = (
        "üëã –ü—Ä–∏–≤–µ—Ç! –Ø –±–æ—Ç –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —Å–∏—Å—Ç–µ–º–Ω—ã—Ö –∫–æ–º–∞–Ω–¥.\n"
        "–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–æ–º–∞–Ω–¥—É **`/shell <–∫–æ–º–∞–Ω–¥–∞>`** –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∫–æ–º–∞–Ω–¥—ã –≤ –º–æ–µ–π –æ–ø–µ—Ä–∞—Ü–∏–æ–Ω–Ω–æ–π —Å–∏—Å—Ç–µ–º–µ –∏ –ø–æ–ª—É—á–µ–Ω–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞."
    )
    bot.reply_to(message, welcome_text, parse_mode='Markdown')

# ---
    
## ‚öôÔ∏è –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /shell
@bot.message_handler(commands=['shell'])
def handle_shell(message):
    """
    –í—ã–ø–æ–ª–Ω—è–µ—Ç —Å–∏—Å—Ç–µ–º–Ω—É—é –∫–æ–º–∞–Ω–¥—É –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é.
    
    –ö–æ–º–∞–Ω–¥–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –≤ —Ñ–æ—Ä–º–∞—Ç–µ: /shell –≤–∞—à–∞_–∫–æ–º–∞–Ω–¥–∞
    """
    try:
        # –ò–∑–≤–ª–µ–∫–∞–µ–º —Ç–µ–∫—Å—Ç –∫–æ–º–∞–Ω–¥—ã –ø–æ—Å–ª–µ /shell 
        # (–ù–∞–ø—Ä–∏–º–µ—Ä, –∏–∑ "/shell ls -l", –º—ã –ø–æ–ª—É—á–∏–º "ls -l")
        command_line = message.text.split(' ', 1)
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –±—ã–ª–∞ –ª–∏ –∫–æ–º–∞–Ω–¥–∞ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–∞
        if len(command_line) < 2:
            bot.reply_to(message, "üö´ **–û—à–∏–±–∫–∞:** –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —É–∫–∞–∂–∏—Ç–µ –∫–æ–º–∞–Ω–¥—É –ø–æ—Å–ª–µ /shell. –ü—Ä–∏–º–µ—Ä: `/shell ls -l`", parse_mode='Markdown')
            return

        command = command_line[1]

        # ‚ùóÔ∏è –ú–ï–†–´ –ë–ï–ó–û–ü–ê–°–ù–û–°–¢–ò:
        # –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –ø—Ä–æ–∏–∑–≤–æ–ª—å–Ω—ã—Ö –∫–æ–º–∞–Ω–¥ –º–æ–∂–µ—Ç –±—ã—Ç—å –æ—á–µ–Ω—å –æ–ø–∞—Å–Ω–æ! 
        # –í —Ä–µ–∞–ª—å–Ω—ã—Ö –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è—Ö –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ:
        # 1. –û–≥—Ä–∞–Ω–∏—á–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ —ç—Ç–æ–π –∫–æ–º–∞–Ω–¥–µ —Ç–æ–ª—å–∫–æ –¥–æ–≤–µ—Ä–µ–Ω–Ω—ã–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º (–ø—Ä–æ–≤–µ—Ä–∫–∞ message.from_user.id).
        # 2. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å "–±–µ–ª—ã–π —Å–ø–∏—Å–æ–∫" —Ä–∞–∑—Ä–µ—à–µ–Ω–Ω—ã—Ö –∫–æ–º–∞–Ω–¥.
        
        # –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ —Å–∏—Å—Ç–µ–º–Ω–æ–π –∫–æ–º–∞–Ω–¥—ã
        # 'shell=True' –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∫–æ–º–∞–Ω–¥—ã –≤ —Å–∏—Å—Ç–µ–º–Ω–æ–π –æ–±–æ–ª–æ—á–∫–µ
        # 'capture_output=True' –¥–ª—è –∑–∞—Ö–≤–∞—Ç–∞ –≤—ã–≤–æ–¥–∞
        # 'text=True' –¥–ª—è –¥–µ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏—è –≤—ã–≤–æ–¥–∞ –∫–∞–∫ —Ç–µ–∫—Å—Ç
        result = subprocess.run(
            command,
            shell=True,
            capture_output=True,
            text=True,
            timeout=10 # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–∞–π–º–∞—É—Ç –≤ 10 —Å–µ–∫—É–Ω–¥
        )
        
        # –§–æ—Ä–º–∏—Ä—É–µ–º –æ—Ç–≤–µ—Ç
        output = result.stdout
        error = result.stderr

        response_parts = []
        
        if output:
            response_parts.append(f"**üü¢ –í—ã–≤–æ–¥ –∫–æ–º–∞–Ω–¥—ã:**\n```bash\n{output[:4000]}...\n```" if len(output) > 4000 else f"**üü¢ –í—ã–≤–æ–¥ –∫–æ–º–∞–Ω–¥—ã:**\n```bash\n{output}\n```")
            
        if error:
            response_parts.append(f"**üî¥ –û—à–∏–±–∫–∞ (stderr):**\n```bash\n{error}\n```")

        if not output and not error:
            response_parts.append("‚úÖ **–ö–æ–º–∞–Ω–¥–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ, –Ω–æ –Ω–µ –≤–µ—Ä–Ω—É–ª–∞ –≤—ã–≤–æ–¥ (stdout/stderr).**")

        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –æ—Ç–≤–µ—Ç. –†–∞–∑–±–∏–≤–∞–µ–º –Ω–∞ —á–∞—Å—Ç–∏, –µ—Å–ª–∏ –æ–Ω —Å–ª–∏—à–∫–æ–º –¥–ª–∏–Ω–Ω—ã–π
        full_response = "\n---\n".join(response_parts)
        
        # Telegram –∏–º–µ–µ—Ç –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –Ω–∞ —Ä–∞–∑–º–µ—Ä —Å–æ–æ–±—â–µ–Ω–∏—è (4096 —Å–∏–º–≤–æ–ª–æ–≤).
        # –î–ª—è –ø—Ä–æ—Å—Ç–æ—Ç—ã, –º—ã –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –ø–æ–ª–Ω—ã–π –æ—Ç–≤–µ—Ç.
        bot.reply_to(message, full_response, parse_mode='Markdown')

    except subprocess.TimeoutExpired:
        bot.reply_to(message, f"‚ùå **–û—à–∏–±–∫–∞:** –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –∫–æ–º–∞–Ω–¥—ã `{command}` –ø—Ä–µ–≤—ã—Å–∏–ª–æ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã–π —Ç–∞–π–º–∞—É—Ç (10 —Å–µ–∫—É–Ω–¥).", parse_mode='Markdown')
    except Exception as e:
        bot.reply_to(message, f"‚ùå **–ü—Ä–æ–∏–∑–æ—à–ª–∞ –Ω–µ–ø—Ä–µ–¥–≤–∏–¥–µ–Ω–Ω–∞—è –æ—à–∏–±–∫–∞:**\n```\n{str(e)}\n```", parse_mode='Markdown')

# ---

## ‚ñ∂Ô∏è –ó–∞–ø—É—Å–∫ –±–æ—Ç–∞
if __name__ == '__main__':
    print("üöÄ –ë–æ—Ç –∑–∞–ø—É—â–µ–Ω –∏ –æ–∂–∏–¥–∞–µ—Ç –∫–æ–º–∞–Ω–¥—ã...")
    # 'non_stop=True' –ø–æ–∑–≤–æ–ª—è–µ—Ç –±–æ—Ç—É –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞—Ç—å—Å—è –ø—Ä–∏ –Ω–µ–∫–æ—Ç–æ—Ä—ã—Ö –æ—à–∏–±–∫–∞—Ö
    # 'interval=0' –æ–∑–Ω–∞—á–∞–µ—Ç –Ω–µ–º–µ–¥–ª–µ–Ω–Ω—ã–π –æ–ø—Ä–æ—Å
    try:
        bot.polling(non_stop=True, interval=0)
    except Exception as e:
        print(f"–ü—Ä–æ–∏–∑–æ—à–ª–∞ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ –±–æ—Ç–∞: {e}")
